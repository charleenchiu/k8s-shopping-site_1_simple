//將此檔案內容copy至Jenkins Server的建置ITEM "Terraform Destroy"的pipeline script欄位中，執行Build
pipeline {
    agent any

    environment {
        AWS_ACCESS_KEY_ID = credentials('AWS_ACCESS_KEY_ID')
        AWS_SECRET_ACCESS_KEY = credentials('AWS_SECRET_ACCESS_KEY')
    }

    stages {
        stage('Checkout') {
            steps {
                // 手動配置 Git 檢出
                git branch: '1_simple', url: 'https://github.com/charleenchiu/k8s-shopping-site.git'
            }
        }

        stage('Terraform Init') {
            steps {
                // 初始化 Terraform
                sh 'terraform init'
            }
        }

        stage('Terraform Destroy') {
            steps {
                // 執行 Terraform Destroy
                sh 'terraform destroy -auto-approve'
            }
        }

        stage('Clean Workspace') {
            steps {
                // 刪除工作區下的所有檔案
                deleteDir()
            }
        }
    }

    post {
        always {
            script {
                // 確保在每次構建後都會清理工作區
                cleanWs()
                sh '''
                    #刪除未使用的容器：
                    echo y | docker container prune
                    #刪除未使用的映像：
                    echo y | docker image prune -a
                    #刪除未使用的卷：
                    echo y | docker volume prune
                '''
            }
        }
    }
}
